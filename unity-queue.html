<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Med+ | Gerenciamento de Horários</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./assets/favicon.png" />
    <!-- Bootstrap 5.3 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --med-primary: #3182ce;
        --med-dark: #2c5282;
        --med-light: #f5f9ff;
      }

      body {
        background-color: #f8f9fa;
        color: #212529;
      }

      .navbar-brand {
        font-weight: 700;
        color: var(--med-primary);
      }

      .navbar-brand span {
        color: var(--med-dark);
      }

      .sidebar {
        background-color: white;
        min-height: calc(100vh - 56px);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      }

      .sidebar .nav-link {
        color: #495057;
        border-radius: 5px;
        margin-bottom: 5px;
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background-color: var(--med-light);
        color: var(--med-primary);
      }

      .sidebar .nav-link i {
        margin-right: 10px;
      }

      .card {
        border: none;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        border-radius: 10px;
      }

      .btn-primary {
        background-color: var(--med-primary);
        border-color: var(--med-primary);
      }

      .btn-primary:hover {
        background-color: var(--med-dark);
        border-color: var(--med-dark);
      }

      .time-slot {
        background-color: #e9ecef;
        border-radius: 5px;
        padding: 5px 10px;
        margin: 3px;
        display: inline-block;
        position: relative;
      }

      .time-slot .remove-slot {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .day-column {
        border-right: 1px solid #dee2e6;
        min-height: 200px;
      }

      .day-column:last-child {
        border-right: none;
      }

      .day-header {
        background-color: var(--med-light);
        padding: 10px;
        text-align: center;
        font-weight: bold;
        border-bottom: 1px solid #dee2e6;
      }

      .time-slots-container {
        padding: 10px;
        min-height: 150px;
      }

      .slot-item {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 5px;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }

      .action-btn {
        width: 30px;
        height: 30px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .schedule-card {
        transition: all 0.3s;
      }

      .schedule-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      /* Spinner Styles */
      #loading-spinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.3s;
      }

      #loading-spinner .spinner-border {
        width: 3rem;
        height: 3rem;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand" href="/main-unity.html">
          <i class="bi bi-heart-pulse"></i> Med<span>+</span> Unidade
        </a>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-person-circle"></i>
                <span class="username"></span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="profile-unity.html"
                    ><i class="bi bi-person"></i> Perfil</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-box-arrow-right"></i> Sair</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar bg-white">
          <div class="position-sticky pt-3">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link" href="main-unity.html">
                  <i class="bi bi-speedometer2"></i> Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="unity-records.html">
                  <i class="bi bi-files"></i> Fichas
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="unity-patients.html">
                  <i class="bi bi-people"></i> Pacientes
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="unity-queue.html">
                  <i class="bi bi-calendar-plus"></i> Horários
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2">
              <i class="bi bi-calendar-plus"></i> Gerenciamento de Horários
            </h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <button
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#newScheduleModal"
              >
                <i class="bi bi-plus-lg"></i> Novo Horário
              </button>
            </div>
          </div>

          <!-- Grade de Horários -->
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">Horários Cadastrados</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Especialidade</th>
                      <th>Médico</th>
                      <th>Dias da Semana</th>
                      <th>Horários</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="scheduleTableBody">
                    <!-- Rows will be dynamically inserted here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Visualização Semanal -->
          <div class="card">
            <div class="card-header bg-white">
              <h5 class="mb-0">Visualização Semanal</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Segunda -->
                <div class="col day-column">
                  <div class="day-header">Segunda</div>
                  <div class="time-slots-container"></div>
                </div>
                <!-- Terça -->
                <div class="col day-column">
                  <div class="day-header">Terça</div>
                  <div class="time-slots-container"></div>
                </div>
                <!-- Quarta -->
                <div class="col day-column">
                  <div class="day-header">Quarta</div>
                  <div class="time-slots-container"></div>
                </div>
                <!-- Quinta -->
                <div class="col day-column">
                  <div class="day-header">Quinta</div>
                  <div class="time-slots-container"></div>
                </div>
                <!-- Sexta -->
                <div class="col day-column">
                  <div class="day-header">Sexta</div>
                  <div class="time-slots-container"></div>
                </div>
                <!-- Sábado -->
                <div class="col day-column">
                  <div class="day-header">Sábado</div>
                  <div class="time-slots-container">
                    <div class="text-muted text-center mt-4">Sem horários</div>
                  </div>
                </div>
                <!-- Domingo -->
                <div class="col day-column">
                  <div class="day-header">Domingo</div>
                  <div class="time-slots-container">
                    <div class="text-muted text-center mt-4">Sem horários</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Novo Horário Modal -->
    <div
      class="modal fade"
      id="newScheduleModal"
      tabindex="-1"
      aria-labelledby="newScheduleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="newScheduleModalLabel">
              <i class="bi bi-calendar-plus"></i> Novo Horário
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="newScheduleForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="scheduleSpecialty" class="form-label"
                    >Especialidade</label
                  >
                  <select class="form-select" id="addscheduleSpecialty" required>
                    <option value="">Selecione uma especialidade</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="addscheduleDoctor" class="form-label">Médico</label>
                  <select class="form-select" id="addscheduleDoctor" required>
                    <option value="">Selecione um médico</option>
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Dias da Semana</label>
                <div class="d-flex flex-wrap gap-2">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="addMondayCheck"
                      value="1"
                    />
                    <label class="form-check-label" for="addMondayCheck"
                      >Segunda</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="addTuesdayCheck"
                      value="2"
                    />
                    <label class="form-check-label" for="addTuesdayCheck"
                      >Terça</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="addWednesdayCheck"
                      value="3"
                    />
                    <label class="form-check-label" for="addWednesdayCheck"
                      >Quarta</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="addThursdayCheck"
                      value="4"
                    />
                    <label class="form-check-label" for="addThursdayCheck"
                      >Quinta</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="addFridayCheck"
                      value="5"
                    />
                    <label class="form-check-label" for="addFridayCheck"
                      >Sexta</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="addSaturdayCheck"
                      value="6"
                    />
                    <label class="form-check-label" for="addSaturdayCheck"
                      >Sábado</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="addSundayCheck"
                      value="7"
                    />
                    <label class="form-check-label" for="addSundayCheck"
                      >Domingo</label
                    >
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Horários</label>
                <div id="addTimeSlotsContainer">
                  <!-- Os slots de horário serão adicionados aqui -->
                </div>
                <div class="d-flex gap-2 mt-2">
                  <input
                    type="time"
                    class="form-control"
                    id="addStartTime"
                    style="max-width: 120px"
                  />
                  <span class="align-self-center">às</span>
                  <input
                    type="time"
                    class="form-control"
                    id="addEndTime"
                    style="max-width: 120px"
                  />
                  <button
                    type="button"
                    class="btn btn-sm btn-primary"
                    id="addTimeSlot"
                  >
                    <i class="bi bi-plus"></i> Adicionar
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="newScheduleForm"
              class="btn btn-primary"
            >
              Salvar Horário
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Editar Horário Modal -->
    <div
      class="modal fade"
      id="editScheduleModal"
      tabindex="-1"
      aria-labelledby="editScheduleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editScheduleModalLabel">
              <i class="bi bi-pencil"></i> Editar Horário
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editScheduleForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editscheduleSpecialty" class="form-label"
                    >Especialidade</label
                  >
                  <select
                    class="form-select"
                    id="editscheduleSpecialty"
                    required
                  >
                    <!-- Options populated by JS -->
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="editscheduleDoctor" class="form-label"
                    >Médico</label
                  >
                  <select class="form-select" id="editscheduleDoctor" required>
                     <!-- Options populated by JS -->
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Dias da Semana</label>
                <div class="d-flex flex-wrap gap-2">
                   <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="editMondayCheck"
                      value="1"
                    />
                    <label class="form-check-label" for="editMondayCheck"
                      >Segunda</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="editTuesdayCheck"
                      value="2"
                    />
                    <label class="form-check-label" for="editTuesdayCheck"
                      >Terça</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="editWednesdayCheck"
                      value="3"
                    />
                    <label class="form-check-label" for="editWednesdayCheck"
                      >Quarta</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="editThursdayCheck"
                      value="4"
                    />
                    <label class="form-check-label" for="editThursdayCheck"
                      >Quinta</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="editFridayCheck"
                      value="5"
                    />
                    <label class="form-check-label" for="editFridayCheck"
                      >Sexta</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="editSaturdayCheck"
                      value="6"
                    />
                    <label class="form-check-label" for="editSaturdayCheck"
                      >Sábado</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="editSundayCheck"
                      value="7"
                    />
                    <label class="form-check-label" for="editSundayCheck"
                      >Domingo</label
                    >
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Horários</label>
                <div id="editTimeSlotsContainer">
                  <!-- Time slots populated by JS -->
                </div>
                <div class="d-flex gap-2 mt-2">
                  <input
                    type="time"
                    class="form-control"
                    id="editStartTime"
                    style="max-width: 120px"
                  />
                  <span class="align-self-center">às</span>
                  <input
                    type="time"
                    class="form-control"
                    id="editEndTime"
                    style="max-width: 120px"
                  />
                  <button
                    type="button"
                    class="btn btn-sm btn-primary"
                    id="editAddTimeSlot"
                  >
                    <i class="bi bi-plus"></i> Adicionar
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="editScheduleForm"
              class="btn btn-primary"
            >
              Salvar Alterações
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Deletar Horário Modal -->
    <div
      class="modal fade"
      id="deleteScheduleModal"
      tabindex="-1"
      aria-labelledby="deleteScheduleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-danger" id="deleteScheduleModalLabel">
              <i class="bi bi-exclamation-triangle"></i> Confirmar Exclusão
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Tem certeza que deseja excluir todos os horários de
              <strong></strong>?
            </p>
            <p class="text-danger">
              Esta ação não pode ser desfeita e afetará todos os agendamentos
              futuros.
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-danger">
              Confirmar Exclusão
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5.3 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = "https://ubs-zxgf.onrender.com";
        let currentUser = null;
        let allBackendSchedules = []; // Stores individual schedules from the backend
        let groupedSchedules = []; // Stores grouped schedules for the frontend table
        let doctors = [];

        // Mapping weekdays to the backend enum
        const dayOfWeekMapping = {
            1: "MONDAY", 2: "TUESDAY", 3: "WEDNESDAY", 4: "THURSDAY",
            5: "FRIDAY", 6: "SATURDAY", 7: "SUNDAY"
        };
        const dayNameToEnum = {
            "MONDAY": 1, "TUESDAY": 2, "WEDNESDAY": 3, "THURSDAY": 4,
            "FRIDAY": 5, "SATURDAY": 6, "SUNDAY": 7
        };

        // --- Spinner Functions ---
        function showSpinner() {
            document.getElementById('loading-spinner')?.classList.remove('hidden');
        }

        function hideSpinner() {
            document.getElementById('loading-spinner')?.classList.add('hidden');
        }
        // -------------------------

        document.addEventListener("DOMContentLoaded", async () => {
            showSpinner();
            try {
                await checkAuth();
                await loadInitialData();
                setupEventListeners();
            } catch (error) {
                console.error("Error loading page:", error);
                showError("Critical error loading page: " + error.message);
            } finally {
                hideSpinner();
            }
        });

        async function checkAuth() {
            const token = localStorage.getItem("access_token");
            if (!token) {
                window.location.href = "index.html";
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/users/me`, {
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (!response.ok) throw new Error("Authentication failed");
                currentUser = await response.json();
                updateUserInfo();
                if (!currentUser.roles?.includes("ROLE_UNIT")) { // Or the role that identifies the unit
                    throw new Error("Access not authorized for this feature.");
                }
            } catch (error) {
                localStorage.clear();
                window.location.href = "index.html";
            }
        }

        function updateUserInfo() {
            document.querySelectorAll(".username").forEach((element) => {
                element.textContent = currentUser.name;
            });
        }

        async function loadInitialData() {
            try {
                // 1. Load Doctors from the Unit
                const doctorsRes = await fetch(`${API_BASE}/doctors?unitId=${currentUser.id}`, {
                    headers: { Authorization: `Bearer ${localStorage.getItem("access_token")}` },
                });
                if (!doctorsRes.ok) throw new Error('Failed to load doctors');
                doctors = await doctorsRes.json();

                // 2. Load schedules for each doctor
                allBackendSchedules = [];
                for (const doctor of doctors) {
                    const schedulesRes = await fetch(`${API_BASE}/schedules/doctor/${doctor.id}`, {
                        headers: { Authorization: `Bearer ${localStorage.getItem("access_token")}` },
                    });
                    if (schedulesRes.ok) {
                        const doctorSchedules = await schedulesRes.json();
                        allBackendSchedules.push(...doctorSchedules);
                    } else {
                        console.warn(`Failed to load schedules for Dr. ${doctor.name}`);
                    }
                }

                // 3. Process and render data
                groupSchedulesForFrontend();
                renderSchedulesTable();
                populateFormSelects("add"); // Populate the "new" modal selects
                renderWeeklyView();

            } catch (error) {
                showError("Error loading initial data: " + error.message);
            }
        }

        function groupSchedulesForFrontend() {
            groupedSchedules = [];
            const schedulesByDoctor = {};

            allBackendSchedules.forEach(backendSchedule => {
                const doctorId = backendSchedule.doctorId;
                if (!schedulesByDoctor[doctorId]) {
                    schedulesByDoctor[doctorId] = {
                        doctorId: doctorId,
                        doctorName: backendSchedule.doctorName,
                        specialization: doctors.find(d => d.id === doctorId)?.specialization || "N/A",
                        timeSlotToDaysMap: new Map()
                    };
                }

                const slotKey = `${backendSchedule.startTime}-${backendSchedule.endTime}`;
                if (!schedulesByDoctor[doctorId].timeSlotToDaysMap.has(slotKey)) {
                    schedulesByDoctor[doctorId].timeSlotToDaysMap.set(slotKey, new Set());
                }
                schedulesByDoctor[doctorId].timeSlotToDaysMap.get(slotKey).add(backendSchedule.dayOfWeek);
            });

            for (const doctorId in schedulesByDoctor) {
                const data = schedulesByDoctor[doctorId];
                const frontendSchedule = {
                    id: allBackendSchedules.find(s => s.doctorId == doctorId)?.id,
                    doctorId: data.doctorId,
                    doctorName: data.doctorName,
                    specialization: data.specialization,
                    daysAndSlots: []
                };

                data.timeSlotToDaysMap.forEach((daysSet, slotKey) => {
                    const [start, end] = slotKey.split('-');
                    frontendSchedule.daysAndSlots.push({
                        daysRaw: Array.from(daysSet), // ex: ["MONDAY", "WEDNESDAY"]
                        daysNumeric: Array.from(daysSet).map(dayStr => dayNameToEnum[dayStr]).sort((a,b) => a-b), // ex: [1, 3]
                        timeSlot: { start, end }
                    });
                });
                groupedSchedules.push(frontendSchedule);
            }
        }

        function renderSchedulesTable() {
            const tbody = document.querySelector("#scheduleTableBody");
            if (!tbody) return;

            const daysMap = { 1: "Seg", 2: "Ter", 3: "Qua", 4: "Qui", 5: "Sex", 6: "Sáb", 7: "Dom" };

            if (groupedSchedules.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">Nenhum horário cadastrado.</td></tr>`;
                 return;
            }

            tbody.innerHTML = groupedSchedules.map(gs => {
                let daysDisplay = new Set();
                let slotsDisplay = new Set();

                gs.daysAndSlots.forEach(ds => {
                    ds.daysNumeric.forEach(dayNum => daysDisplay.add(daysMap[dayNum]));
                    slotsDisplay.add(`${ds.timeSlot.start} - ${ds.timeSlot.end}`);
                });

                return `
                <tr data-doctor-id="${gs.doctorId}">
                    <td>${gs.specialization}</td>
                    <td>${gs.doctorName}</td>
                    <td>${Array.from(daysDisplay).sort((a,b) => Object.values(daysMap).indexOf(a) - Object.values(daysMap).indexOf(b)).join(', ')}</td>
                    <td>${Array.from(slotsDisplay).sort().map(slot => `<span class="time-slot">${slot}</span>`).join('')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary action-btn edit-schedule" title="Editar horários de ${gs.doctorName}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger action-btn delete-schedule" title="Excluir todos os horários de ${gs.doctorName}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            }).join("");
        }

        function renderWeeklyView() {
            const dayColumns = {
                MONDAY: document.querySelector('.row .day-column:nth-child(1) .time-slots-container'),
                TUESDAY: document.querySelector('.row .day-column:nth-child(2) .time-slots-container'),
                WEDNESDAY: document.querySelector('.row .day-column:nth-child(3) .time-slots-container'),
                THURSDAY: document.querySelector('.row .day-column:nth-child(4) .time-slots-container'),
                FRIDAY: document.querySelector('.row .day-column:nth-child(5) .time-slots-container'),
                SATURDAY: document.querySelector('.row .day-column:nth-child(6) .time-slots-container'),
                SUNDAY: document.querySelector('.row .day-column:nth-child(7) .time-slots-container'),
            };

            // Clear existing columns
            for (const dayKey in dayColumns) {
                if (dayColumns[dayKey]) dayColumns[dayKey].innerHTML = '';
            }

            allBackendSchedules.forEach(schedule => {
                const dayContainer = dayColumns[schedule.dayOfWeek];
                if (dayContainer) {
                    const doctor = doctors.find(d => d.id === schedule.doctorId);
                    const slotItem = document.createElement('div');
                    slotItem.className = 'slot-item';
                    slotItem.innerHTML = `
                        <strong>${doctor?.specialization || 'N/A'}</strong><br />
                        ${schedule.doctorName}<br />
                        ${schedule.startTime} - ${schedule.endTime}
                    `;
                    dayContainer.appendChild(slotItem);
                }
            });

            // Add "No schedules" message if the column is empty
            for (const dayKey in dayColumns) {
                if (dayColumns[dayKey] && dayColumns[dayKey].children.length === 0) {
                    dayColumns[dayKey].innerHTML = '<div class="text-muted text-center mt-4">Sem horários</div>';
                }
            }
        }

        function populateFormSelects(formPrefix) { // formPrefix is "add" or "edit"
            const specialtySelect = document.getElementById(`${formPrefix}scheduleSpecialty`);
            const doctorSelect = document.getElementById(`${formPrefix}scheduleDoctor`);

            const uniqueSpecialties = [...new Set(doctors.map(d => d.specialization).filter(Boolean))];

            if (specialtySelect) {
                const currentDoctorVal = doctorSelect.value;
                specialtySelect.innerHTML = '<option value="">Selecione uma especialidade</option>' +
                    uniqueSpecialties.map(s => `<option value="${s}">${s}</option>`).join("");

                // Event listener to populate doctors based on specialty
                specialtySelect.onchange = function() {
                    const selectedSpecialty = this.value;
                    const filteredDoctors = selectedSpecialty ? doctors.filter(d => d.specialization === selectedSpecialty) : doctors;
                    if (doctorSelect) {
                        doctorSelect.innerHTML = '<option value="">Selecione um médico</option>' +
                            filteredDoctors.map(d => `<option value="${d.id}">${d.name}</option>`).join("");
                    }
                };
            }

            // Populate doctors initially (all)
            if (doctorSelect) {
                const currentSpecialty = specialtySelect.value;
                const filteredDoctors = currentSpecialty ? doctors.filter(d => d.specialization === currentSpecialty) : doctors;
                doctorSelect.innerHTML = '<option value="">Selecione um médico</option>' +
                     filteredDoctors.map(d => `<option value="${d.id}">${d.name}</option>`).join("");
            }
        }


        function setupEventListeners() {
            document.querySelector('.dropdown-item[href="#"]')?.addEventListener("click", () => {
                localStorage.clear();
                window.location.href = "index.html";
            });

            document.getElementById("addTimeSlot")?.addEventListener("click", function() { addTimeSlot('add'); });
            document.getElementById("editAddTimeSlot")?.addEventListener("click", function() { addTimeSlot('edit'); });

            document.addEventListener("click", function (e) {
                if (e.target.matches(".remove-slot, .remove-slot *")) {
                    e.target.closest(".time-slot").remove();
                }
            });

            document.getElementById("newScheduleForm")?.addEventListener("submit", handleCreateSchedule);
            document.getElementById("editScheduleForm")?.addEventListener("submit", handleUpdateSchedule);

            document.querySelector("#scheduleTableBody")?.addEventListener("click", function (e) {
                const btn = e.target.closest("button.action-btn");
                if (!btn) return;

                const row = btn.closest("tr");
                const doctorId = row?.getAttribute("data-doctor-id");

                if (btn.classList.contains("edit-schedule")) {
                    openEditScheduleModal(doctorId);
                } else if (btn.classList.contains("delete-schedule")) {
                    openDeleteScheduleModal(doctorId);
                }
            });

            document.querySelector("#deleteScheduleModal .btn-danger")?.addEventListener("click", handleDeleteSchedule);
        }

        function addTimeSlot(formTypePrefix) { // 'add' or 'edit'
            const startTimeInput = document.getElementById(`${formTypePrefix}StartTime`);
            const endTimeInput = document.getElementById(`${formTypePrefix}EndTime`);
            const container = document.getElementById(`${formTypePrefix}TimeSlotsContainer`);

            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;

            if (!startTime || !endTime) {
                showError("Por favor, preencha ambos os horários (início e fim).");
                return;
            }
            if (startTime >= endTime) {
                showError("O horário de início deve ser anterior ao horário de término.");
                return;
            }

            const slot = document.createElement("span");
            slot.className = "time-slot";
            slot.innerHTML = `${startTime} - ${endTime} <span class="remove-slot" title="Remover horário">×</span>`;
            container.appendChild(slot);

            startTimeInput.value = "";
            endTimeInput.value = "";
        }

        function getScheduleFormData(formId) {
            const form = document.getElementById(formId);
            const isEdit = formId === "editScheduleForm";
            const prefix = isEdit ? "edit" : "add";

            const doctorId = form.querySelector(`#${prefix}scheduleDoctor`).value;
            if (!doctorId) throw new Error("Selecione um médico.");

            const selectedDays = [];
            for (let i = 1; i <= 7; i++) {
                const checkboxId = `${prefix}${getDayName(i)}Check`; // e.g. addMondayCheck
                const checkbox = document.getElementById(checkboxId);
                if (checkbox?.checked) {
                    selectedDays.push(dayOfWeekMapping[i]); // Map 1 to MONDAY, etc.
                }
            }
            if (selectedDays.length === 0) throw new Error("Selecione pelo menos um dia da semana.");

            const timeSlotsContainer = document.getElementById(`${prefix}TimeSlotsContainer`);
            const timeSlots = Array.from(timeSlotsContainer.querySelectorAll(".time-slot")).map(slotEl => {
                const text = slotEl.textContent.trim().replace('×','').trim(); // Remove '×' and extra spaces
                const [start, end] = text.split(" - ");
                return { start: start.trim(), end: end.trim() }; // HH:mm format
            });

            if (timeSlots.length === 0) throw new Error("Adicione pelo menos um intervalo de horário.");

            return { doctorId, daysOfWeek: selectedDays, timeSlots };
        }


        async function handleCreateSchedule(e) {
            e.preventDefault();
            showSpinner();
            try {
                const { doctorId, daysOfWeek, timeSlots } = getScheduleFormData("newScheduleForm");

                const creationPromises = [];
                for (const day of daysOfWeek) {
                    for (const slot of timeSlots) {
                        const payload = {
                            doctorId: parseInt(doctorId),
                            dayOfWeek: day,
                            startTime: slot.start,
                            endTime: slot.end,
                        };
                        creationPromises.push(
                            fetch(`${API_BASE}/schedules`, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${localStorage.getItem("access_token")}`,
                                },
                                body: JSON.stringify(payload),
                            }).then(res => {
                                if (!res.ok) return res.json().then(err => Promise.reject(err));
                                return res.json();
                            })
                        );
                    }
                }

                await Promise.all(creationPromises);

                // Hide modal first, then reload data
                bootstrap.Modal.getInstance(document.getElementById("newScheduleModal")).hide();
                e.target.reset();
                document.getElementById("addTimeSlotsContainer").innerHTML = "";
                showSuccess("Horário(s) criado(s) com sucesso!");

                await loadInitialData(); // Reload and regroup everything

            } catch (error) {
                console.error("Error creating schedule:", error);
                showError(error.message || error.errors?.[0]?.defaultMessage || "Unknown error creating schedule.");
            } finally {
                hideSpinner();
            }
        }

        function openEditScheduleModal(doctorId) {
            const doctorSchedules = allBackendSchedules.filter(s => s.doctorId == doctorId);
            if (doctorSchedules.length === 0) {
                showError("No schedules found for this doctor to edit.");
                return;
            }

            const doctor = doctors.find(d => d.id == doctorId);
            const form = document.getElementById("editScheduleForm");
            form.dataset.editingDoctorId = doctorId; // Store the doctor's ID

            // Populate selects
            populateFormSelects('edit');

            // Pre-select the correct doctor and specialty
            document.getElementById("editscheduleSpecialty").value = doctor?.specialization || "";
            // Trigger the onchange manually to filter doctors
            document.getElementById("editscheduleSpecialty").dispatchEvent(new Event('change'));
            document.getElementById("editscheduleDoctor").value = String(doctorId);

            document.getElementById("editscheduleDoctor").disabled = true;
            document.getElementById("editscheduleSpecialty").disabled = true;

            // Check the weekdays (aggregated from all doctor's schedules)
            const activeDays = new Set();
            doctorSchedules.forEach(s => activeDays.add(s.dayOfWeek)); // MONDAY, TUESDAY...

            for (let i = 1; i <= 7; i++) {
                const dayEnum = dayOfWeekMapping[i]; // MONDAY, TUESDAY...
                const checkbox = document.getElementById(`edit${getDayName(i)}Check`);
                if(checkbox) checkbox.checked = activeDays.has(dayEnum);
            }

            // Fill in time slots (aggregated and unique)
            const timeSlotsSet = new Set();
            doctorSchedules.forEach(s => timeSlotsSet.add(`${s.startTime} - ${s.endTime}`));

            const container = document.getElementById("editTimeSlotsContainer");
            container.innerHTML = ""; // Clear previous slots
            timeSlotsSet.forEach(slotString => {
                const slotElement = document.createElement("span");
                slotElement.className = "time-slot";
                slotElement.innerHTML = `${slotString} <span class="remove-slot" title="Remover horário">×</span>`;
                container.appendChild(slotElement);
            });

            new bootstrap.Modal(document.getElementById("editScheduleModal")).show();
        }


        async function handleUpdateSchedule(e) {
            e.preventDefault();
            showSpinner();
            const form = e.target;
            const doctorId = form.dataset.editingDoctorId;

            if (!doctorId) {
                showError("Doctor ID not found for update.");
                hideSpinner();
                return;
            }

            try {
                const { daysOfWeek: newDaysEnum, timeSlots: newTimeSlots } = getScheduleFormData("editScheduleForm");

                const existingSchedulesForDoctor = allBackendSchedules.filter(s => s.doctorId == doctorId);

                const schedulesToDelete = existingSchedulesForDoctor.filter(existing => {
                    const isDayPresent = newDaysEnum.includes(existing.dayOfWeek);
                    const isSlotPresent = newTimeSlots.some(newSlot =>
                        newSlot.start === existing.startTime && newSlot.end === existing.endTime
                    );
                    return !(isDayPresent && isSlotPresent);
                });

                const schedulesToAddPayloads = [];
                for (const day of newDaysEnum) {
                    for (const slot of newTimeSlots) {
                        const alreadyExists = existingSchedulesForDoctor.some(existing =>
                            existing.dayOfWeek === day &&
                            existing.startTime === slot.start &&
                            existing.endTime === slot.end
                        );
                        if (!alreadyExists) {
                            schedulesToAddPayloads.push({
                                doctorId: parseInt(doctorId),
                                dayOfWeek: day,
                                startTime: slot.start,
                                endTime: slot.end,
                            });
                        }
                    }
                }

                const apiPromises = [];

                // Execute deletions
                schedulesToDelete.forEach(s => {
                    apiPromises.push(
                        fetch(`${API_BASE}/schedules/${s.id}`, {
                            method: "DELETE",
                            headers: { Authorization: `Bearer ${localStorage.getItem("access_token")}` },
                        }).then(res => { if (!res.ok) return res.json().then(err => Promise.reject(err)); })
                    );
                });

                // Execute additions
                schedulesToAddPayloads.forEach(payload => {
                    apiPromises.push(
                        fetch(`${API_BASE}/schedules`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${localStorage.getItem("access_token")}`,
                            },
                            body: JSON.stringify(payload),
                        }).then(res => { if (!res.ok) return res.json().then(err => Promise.reject(err)); })
                    );
                });

                await Promise.all(apiPromises);

                bootstrap.Modal.getInstance(document.getElementById("editScheduleModal")).hide();
                showSuccess("Doctor's schedules updated successfully!");
                await loadInitialData(); // Reload everything

            } catch (error) {
                console.error("Error updating schedules:", error);
                showError(error.message || error.errors?.[0]?.defaultMessage || "Error updating schedules.");
            } finally {
                // Re-enable doctor and specialty selects
                document.getElementById("editscheduleDoctor").disabled = false;
                document.getElementById("editscheduleSpecialty").disabled = false;
                hideSpinner();
            }
        }


        async function handleDeleteSchedule() {
            showSpinner();
            const modal = document.getElementById("deleteScheduleModal");
            const doctorId = modal.dataset.doctorIdForDeletion;

            if (!doctorId) {
                showError("Doctor ID not found for deletion.");
                hideSpinner();
                return;
            }

            try {
                // Find all schedule IDs for this doctor
                const schedulesForDoctor = allBackendSchedules.filter(s => s.doctorId == doctorId);
                if (schedulesForDoctor.length === 0) {
                    showSuccess("Doctor already has no registered schedules.");
                    bootstrap.Modal.getInstance(modal).hide();
                    return;
                }

                const deletionPromises = schedulesForDoctor.map(s =>
                    fetch(`${API_BASE}/schedules/${s.id}`, {
                        method: "DELETE",
                        headers: { Authorization: `Bearer ${localStorage.getItem("access_token")}` },
                    }).then(res => { if (!res.ok) return res.json().then(err => Promise.reject(err)); })
                );

                await Promise.all(deletionPromises);

                bootstrap.Modal.getInstance(modal).hide();
                showSuccess("All doctor's schedules have been successfully deleted!");
                await loadInitialData();

            } catch (error) {
                console.error("Error deleting doctor's schedules:", error);
                showError(error.message || "Error deleting schedules.");
            } finally {
                hideSpinner();
            }
        }

        function openDeleteScheduleModal(doctorId) {
            const doctor = doctors.find(d => d.id == doctorId);
            if (!doctor) return;

            const modal = document.getElementById("deleteScheduleModal");
            modal.querySelector("strong").textContent = `${doctor.specialization || 'N/A'} - ${doctor.name}`;
            modal.dataset.doctorIdForDeletion = doctorId;
            new bootstrap.Modal(modal).show();
        }

        function getDayName(dayNumber) { // 1=Monday, ..., 7=Sunday
            const dayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            return dayNames[dayNumber - 1];
        }

        // --- Custom Alert/Toast Functions ---
        // You can replace these with a more robust toast/notification library
        function showError(message) {
            console.error("Error:", message);
            // This is a placeholder. For a better UX, use a non-blocking toast notification.
            alert(`ERRO: ${message}`);
        }

        function showSuccess(message) {
            console.log("Success:", message);
            // This is a placeholder.
            alert(`SUCESSO: ${message}`);
        }
    </script>
  </body>
</html>
