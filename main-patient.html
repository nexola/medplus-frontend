<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Med+ | Fichas do Paciente</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./assets/favicon.png" />
    <!-- Bootstrap 5.3 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --med-primary: #3182ce;
        --med-dark: #2c5282;
        --med-light: #f5f9ff;
      }

      body {
        background-color: #f8f9fa;
        color: #212529;
      }

      .navbar-brand {
        font-weight: 700;
        color: var(--med-primary);
      }

      .navbar-brand span {
        color: var(--med-dark);
      }

      .card {
        border: none;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        border-radius: 10px;
      }

      .table th {
        background-color: var(--med-light);
        color: var(--med-dark);
        border-top: none;
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .status-agendado {
        background-color: #e3f2fd;
        color: #1976d2;
      }

      .status-concluido {
        background-color: #e8f5e9;
        color: #388e3c;
      }

      .status-confirmado {
        background-color: #e8f5e9;
        color: #388e3c;
      }

      #confirmAppointmentBtn,
      #cancelAppointmentBtn {
        display: none;
      }

      .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
      }

      .btn-danger:hover {
        background-color: #bb2d3b;
        border-color: #b02a37;
      }

      .status-cancelado {
        background-color: #ffebee;
        color: #d32f2f;
      }

      .status-pendente {
        background-color: #fff8e1;
        color: #ffa000;
      }

      .nav-pills .nav-link.active {
        background-color: var(--med-primary);
      }

      .btn-primary {
        background-color: var(--med-primary);
        border-color: var(--med-primary);
      }

      .btn-primary:hover {
        background-color: var(--med-dark);
        border-color: var(--med-dark);
      }

      .patient-info-card {
        border-left: 4px solid var(--med-primary);
      }
    </style>
  </head>
  <body>
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-heart-pulse"></i> Med<span>+</span> Paciente
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#"
                ><i class="bi bi-files"></i> Fichas</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="profile-patient.html"
                ><i class="bi bi-person"></i> Perfil</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="logoutBtn">
                <i class="bi bi-box-arrow-right"></i> Sair
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <div class="row">
        <main class="col-12">
          <!-- Patient Info Card -->
          <div class="card patient-info-card mb-4">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-2 text-center">
                  <img
                    src="https://randomuser.me/api/portraits/men/32.jpg"
                    alt="Patient"
                    class="rounded-circle mb-3"
                    width="80"
                    height="80"
                  />
                </div>
                <div class="col-md-4">
                  <h5 class="mb-1">Carregando...</h5>
                  <p class="text-muted mb-1">...</p>
                </div>
                <div class="col-md-4">
                  <!-- Espaço para informações adicionais se necessário -->
                </div>
                <div class="col-md-2 text-end">
                  <button
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#newFichaModal"
                  >
                    <i class="bi bi-plus-lg"></i> Nova Ficha
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header bg-white">
              <h5 class="card-title mb-0">
                <i class="bi bi-files"></i> Minhas Fichas Médicas
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th>Código</th>
                      <th>Data</th>
                      <th>Médico</th>
                      <th>Especialidade</th>
                      <th>Status</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="appointmentsTableBody">
                    <!-- Linhas da tabela serão inseridas aqui pelo JavaScript -->
                    <tr>
                        <td colspan="6" class="text-center">Carregando agendamentos...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- New Ficha Modal -->
    <div class="modal fade" id="newFichaModal" tabindex="-1" aria-labelledby="newFichaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="newFichaModalLabel">
              <i class="bi bi-file-earmark-plus"></i> Novo Agendamento
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="newFichaForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="fichaDate" class="form-label">Data</label>
                  <input
                    type="date"
                    class="form-control"
                    id="fichaDate"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="fichaTime" class="form-label">Hora</label>
                  <input
                    type="time"
                    class="form-control"
                    id="fichaTime"
                    required
                  />
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="fichaDoctor" class="form-label">Médico</label>
                  <select class="form-select" id="fichaDoctor" required>
                    <option value="">Carregando médicos...</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="fichaType" class="form-label">Tipo</label>
                  <select class="form-select" id="fichaType" required>
                    <option value="">Selecione o tipo</option>
                    <option value="CONSULTA">Consulta</option>
                    <option value="RETORNO">Retorno</option>
                    <option value="EXAME">Exame</option>
                    <option value="EMERGENCIA">Emergência</option>
                    <option value="OUTRO">Outro</option>
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label for="fichaReason" class="form-label">Motivo/Descrição Principal</label>
                <textarea
                  class="form-control"
                  id="fichaReason"
                  rows="3"
                  placeholder="Descreva o motivo principal do agendamento"
                  required
                ></textarea>
              </div>

              <div class="mb-3">
                <label for="fichaSymptoms" class="form-label">Sintomas (Opcional)</label>
                <textarea
                  class="form-control"
                  id="fichaSymptoms"
                  rows="2"
                  placeholder="Descreva brevemente quaisquer sintomas"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="submit" form="newFichaForm" class="btn btn-primary">
              Criar Agendamento
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Ficha Modal -->
    <div class="modal fade" id="viewFichaModal" tabindex="-1" aria-labelledby="viewFichaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewFichaModalTitle">
              <i class="bi bi-file-earmark-text"></i> Detalhes da Ficha
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-4">
              <div class="col-md-6">
                <h6>Informações Básicas</h6>
                <p><strong>Paciente:</strong> <span id="viewPatientName">Carregando...</span></p>
                <p><strong>Data:</strong> <span id="viewAppointmentDate">Carregando...</span></p>
                <p><strong>Médico:</strong> <span id="viewDoctorName">Carregando...</span></p>
                <p><strong>Especialidade:</strong> <span id="viewDoctorSpecialty">Carregando...</span></p>
                <p><strong>Status:</strong> <span id="viewAppointmentStatus" class="status-badge">Carregando...</span></p>
              </div>
              <div class="col-md-6">
                <h6>Detalhes</h6>
                <p><strong>Tipo:</strong> <span id="viewAppointmentType">Carregando...</span></p>
                <p><strong>Motivo/Descrição:</strong> <span id="viewAppointmentReason">Carregando...</span></p>
                <p><strong>Sintomas/Diagnóstico:</strong> <span id="viewAppointmentSymptoms">Carregando...</span></p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Fechar
            </button>
            <button type="button" class="btn btn-primary" id="printFichaBtn" disabled>
              <i class="bi bi-printer"></i> Imprimir (Em breve)
            </button>
            <button type="button" class="btn btn-danger" id="cancelAppointmentBtn">
              <i class="bi bi-x-circle"></i> Não Poderei Ir
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Sucesso -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="successModalLabel">
              <i class="bi bi-check-circle-fill"></i> Sucesso!
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="successModalBody">
            Operação realizada com sucesso.
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-success"
              data-bs-dismiss="modal"
            >
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5.3 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = "https://ubs-zxgf.onrender.com";
        // const API_BASE = "http://localhost:8080";
        let currentUser = null;
        let currentAppointments = [];
        let allDoctors = [];

        // Função auxiliar para remover o backdrop com segurança
        function removeModalBackdropSafe() {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.classList.remove('show');
                setTimeout(() => {
                    if (backdrop.parentElement) {
                        backdrop.remove();
                    }
                    if (!document.querySelector('.modal.show')) {
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }
                }, 150);
            } else {
                if (!document.querySelector('.modal.show')) {
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await checkAuth();
                if (currentUser) {
                    await loadPatientData();
                    await loadAppointments();
                    await loadDoctorsForSelect();
                    setupEventListeners();
                }
            } catch (error) {
                console.error("PFSCR: Erro na inicialização da página do paciente:", error);
                // checkAuth já lida com redirecionamento, mas um log aqui é útil.
                // Se não houver currentUser, a página não deve carregar mais nada.
            }
        });

        async function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'index.html';
                throw new Error("PFSCR: Token não encontrado, redirecionando para login.");
            }
            try {
                const response = await fetch(`${API_BASE}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = 'index.html';
                        throw new Error('PFSCR: Sessão expirada ou inválida, redirecionando.');
                    }
                    const errorData = await response.json().catch(() => ({ message: 'PFSCR: Falha na autenticação, resposta não JSON.' }));
                    throw new Error(`PFSCR: Falha na autenticação: ${errorData.message || response.statusText}`);
                }
                currentUser = await response.json();
                if (!currentUser.roles?.includes('ROLE_PATIENT')) {
                    throw new Error('PFSCR: Acesso não autorizado para pacientes.');
                }
                localStorage.setItem('currentUserData', JSON.stringify(currentUser)); // Opcional
            } catch (error) {
                console.error("PFSCR: Erro em checkAuth:", error.message);
                localStorage.clear();
                if (!window.location.pathname.endsWith('index.html')) {
                    window.location.href = 'index.html';
                }
                throw error;
            }
        }

        async function loadPatientData() {
            if (!currentUser) {
                showError("PFSCR: Dados do paciente não puderam ser carregados (usuário não definido).");
                return;
            }
            try {
                document.querySelector('.patient-info-card h5').textContent = currentUser.name || 'Paciente';
                const birthDate = currentUser.birthDate || currentUser.birth_date; // Tentar os dois nomes de campo comuns
                let ageDisplay = 'Idade não informada';
                if (birthDate) {
                    const birth = new Date(birthDate);
                    const today = new Date();
                    let age = today.getFullYear() - birth.getFullYear();
                    const m = today.getMonth() - birth.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                        age--;
                    }
                    ageDisplay = `${age} anos`;
                }

                document.querySelector('.patient-info-card .text-muted').innerHTML = `
                    ${ageDisplay}<br/>
                    <i class="bi bi-envelope"></i> ${currentUser.email || 'N/A'}<br>
                    <i class="bi bi-telephone"></i> ${currentUser.phone || 'N/A'}
                `;
            } catch (error) {
                showError("PFSCR: Erro ao exibir dados do paciente: " + error.message);
            }
        }

        async function loadDoctorsForSelect() {
            try {
                const response = await fetch(`${API_BASE}/doctors`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (!response.ok) throw new Error('PFSCR: Falha ao carregar lista de médicos.');
                allDoctors = await response.json();
                const doctorSelect = document.getElementById('fichaDoctor');
                if (doctorSelect) {
                    doctorSelect.innerHTML = '<option value="">Selecione um médico</option>';
                    allDoctors.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.id;
                        // Verifica se specialization existe e não é nulo antes de toLowerCase
                        const specializationText = doctor.specialization ? doctor.specialization.toLowerCase() : 'N/A';
                        option.textContent = `${doctor.name} (${specializationText})`;
                        doctorSelect.appendChild(option);
                    });
                }
            } catch (error) {
                showError("PFSCR: Erro ao carregar médicos: " + error.message);
                const doctorSelect = document.getElementById('fichaDoctor');
                if (doctorSelect) doctorSelect.innerHTML = '<option value="">Erro ao carregar médicos</option>';
            }
        }

        async function loadAppointments() {
            if (!currentUser) return;
            const tbody = document.getElementById('appointmentsTableBody'); // Seleciona o tbody aqui
            if (!tbody) {
                console.error("PFSCR: Elemento tbody com ID 'appointmentsTableBody' não encontrado.");
                return;
            }
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">Carregando seus agendamentos...</td></tr>`; // Feedback de carregamento

            try {
                const response = await fetch(`${API_BASE}/appointments/patient`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'PFSCR: Falha ao carregar fichas.' }));
                    throw new Error(errorData.message || 'PFSCR: Falha ao carregar fichas.');
                }
                currentAppointments = await response.json();
                renderAppointments();
            } catch (error) {
                showError("PFSCR: Erro ao carregar seus agendamentos: " + error.message);
                if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Não foi possível carregar seus agendamentos. Tente novamente mais tarde.</td></tr>`;
            }
        }

        function renderAppointments() {
            const tbody = document.getElementById('appointmentsTableBody');
            if (!tbody) return;

            if (!currentAppointments || currentAppointments.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">Você ainda não possui fichas ou agendamentos.</td></tr>`;
                return;
            }

            tbody.innerHTML = currentAppointments.map(appointment => {
                const localDate = new Date(appointment.date);
                const formattedDate = localDate.toLocaleDateString('pt-BR');
                const formattedTime = localDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                let stateText = 'N/A';
                if (appointment.state) {
                    stateText = appointment.state.replace(/_/g, ' ').toLowerCase();
                    stateText = stateText.charAt(0).toUpperCase() + stateText.slice(1);
                }

                return `
                    <tr data-appointment-id="${appointment.id}">
                        <td>#FCH-${String(appointment.id).padStart(4, '0')}</td>
                        <td>${formattedDate} • ${formattedTime}</td>
                        <td>${appointment.doctor?.name || 'N/A'}</td>
                        <td>${appointment.doctor?.specialization || 'N/A'}</td>
                        <td>
                        <span class="status-badge status-${getStatusClass(appointment.state)}">
                            ${stateText}
                        </span>
                        </td>
                        <td>
                        <button class="btn btn-sm btn-outline-primary view-btn"
                            data-id="${appointment.id}"
                            title="Visualizar Detalhes"
                            data-bs-toggle="modal"
                            data-bs-target="#viewFichaModal">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${appointment.state === 'AGENDADO' && isAppointmentInFuture(appointment.date) ?
                            `<button class="btn btn-sm btn-outline-danger cancel-btn-row ms-1"
                                    data-id="${appointment.id}"
                                    title="Cancelar Agendamento">
                                <i class="bi bi-x-circle"></i>
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function isAppointmentInFuture(appointmentDateStr) {
            if (!appointmentDateStr) return false;
            const appointmentDate = new Date(appointmentDateStr);
            const now = new Date();
            // Compara apenas a data, desconsiderando a hora para "futuro"
            appointmentDate.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            return appointmentDate >= now; // Maior ou igual a hoje
        }

        function setupEventListeners() {
            document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.clear();
                window.location.href = 'index.html';
            });

            const newFichaForm = document.getElementById('newFichaForm');
            if (newFichaForm) {
                newFichaForm.addEventListener('submit', handleCreateNewFicha);
            }

            const viewFichaModalElement = document.getElementById('viewFichaModal');
            if (viewFichaModalElement) {
                viewFichaModalElement.addEventListener('show.bs.modal', async function(event) {
                    const button = event.relatedTarget;
                    if (button && button.classList.contains('view-btn')) {
                        const appointmentId = button.dataset.id;
                        this.dataset.currentAppointmentId = appointmentId;
                        await populateViewFichaModal(appointmentId);
                    }
                });
                viewFichaModalElement.addEventListener('hidden.bs.modal', removeModalBackdropSafe);
            }

            const newFichaModalElement = document.getElementById('newFichaModal');
            if (newFichaModalElement) {
                newFichaModalElement.addEventListener('hidden.bs.modal', removeModalBackdropSafe);
            }

            const successModalElement = document.getElementById('successModal');
            if (successModalElement) {
                successModalElement.addEventListener('hidden.bs.modal', removeModalBackdropSafe);
            }

            const confirmBtnModal = document.getElementById('confirmAppointmentBtn');
            if (confirmBtnModal) {
                confirmBtnModal.addEventListener('click', async function() {
                    const modal = document.getElementById('viewFichaModal');
                    const appointmentId = modal.dataset.currentAppointmentId;
                    if (appointmentId) {
                        await handleConfirmAppointment(appointmentId);
                    }
                });
            }

            const cancelBtnModal = document.getElementById('cancelAppointmentBtn');
            if (cancelBtnModal) {
                cancelBtnModal.addEventListener('click', async function() {
                    const modal = document.getElementById('viewFichaModal');
                    const appointmentId = modal.dataset.currentAppointmentId;
                    if (appointmentId) {
                        await handleCancelAppointment(appointmentId, "Paciente informou que não poderá comparecer (via modal).");
                    }
                });
            }

            const tableBody = document.getElementById('appointmentsTableBody');
            if (tableBody) {
                tableBody.addEventListener('click', function(event) {
                    const target = event.target.closest('.cancel-btn-row');
                    if (target) {
                        const appointmentId = target.dataset.id;
                        handleCancelAppointment(appointmentId, 'Paciente solicitou cancelamento (via tabela).');
                    }
                });
            }
        }

        async function handleCreateNewFicha(e) {
            e.preventDefault();
            if (!currentUser) {
                showError("PFSCR: Não foi possível identificar o paciente. Faça login novamente.");
                return;
            }

            const localDate = document.getElementById('fichaDate').value;
            const localTime = document.getElementById('fichaTime').value;

            if (!localDate || !localTime) {
                showError('PFSCR: Data e Hora do agendamento são obrigatórias.');
                return;
            }
            const localDateTime = new Date(`${localDate}T${localTime}:00`);
            if (isNaN(localDateTime.getTime())) {
                showError('PFSCR: Data ou Hora inválida.');
                return;
            }
            const appointmentInstant = localDateTime.toISOString();

            const formData = {
                patientId: currentUser.id,
                doctorId: document.getElementById('fichaDoctor').value,
                date: appointmentInstant,
                type: document.getElementById('fichaType').value,
                description: document.getElementById('fichaReason').value,
                diagnosis: document.getElementById('fichaSymptoms').value, // Backend pode tratar isso como 'symptoms' se preferir
                state: "AGENDADO"
            };

            if (!formData.doctorId || !formData.type || !formData.description) {
                showError("PFSCR: Médico, Tipo e Motivo/Descrição são obrigatórios.");
                return;
            }

            const newFichaModalEl = document.getElementById('newFichaModal');
            try {
                const response = await fetch(`${API_BASE}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "PFSCR: Erro ao criar ficha." }));
                    throw new Error(errorData.message || "PFSCR: Erro desconhecido ao criar ficha.");
                }

                if (newFichaModalEl) {
                    const modalInstance = bootstrap.Modal.getInstance(newFichaModalEl);
                    if (modalInstance) {
                        newFichaModalEl.addEventListener('hidden.bs.modal', async function handler() {
                            newFichaModalEl.removeEventListener('hidden.bs.modal', handler);
                            e.target.reset();
                            showSuccess('Agendamento criado com sucesso!');
                            await loadAppointments();
                            removeModalBackdropSafe();
                        }, { once: true });
                        modalInstance.hide();
                    } else { // Fallback
                        e.target.reset();
                        showSuccess('Agendamento criado com sucesso!');
                        await loadAppointments();
                        removeModalBackdropSafe();
                    }
                }
            } catch (error) {
                showError("PFSCR: Erro ao criar agendamento: " + error.message);
                 // Se o modal ainda estiver aberto e houver erro, não fechar automaticamente
                 // mas garantir que o backdrop seja removido se o usuário fechar manualmente.
                if (newFichaModalEl && bootstrap.Modal.getInstance(newFichaModalEl)?._isShown) {
                    // Não faz nada, deixa o usuário fechar ou tentar novamente
                } else {
                    removeModalBackdropSafe(); // Limpa se o modal não estiver mais ativo
                }
            }
        }

        async function populateViewFichaModal(appointmentId) {
            const modal = document.getElementById('viewFichaModal');
            if (!modal) return;

            // Resetar para "Carregando..."
            modal.querySelector('#viewFichaModalTitle').innerHTML = `<i class="bi bi-file-earmark-text"></i> Carregando Ficha...`;
            modal.querySelector('#viewPatientName').textContent = 'Carregando...';
            modal.querySelector('#viewAppointmentDate').textContent = 'Carregando...';
            modal.querySelector('#viewDoctorName').textContent = 'Carregando...';
            modal.querySelector('#viewDoctorSpecialty').textContent = 'Carregando...';
            modal.querySelector('#viewAppointmentStatus').textContent = 'Carregando...';
            modal.querySelector('#viewAppointmentType').textContent = 'Carregando...';
            modal.querySelector('#viewAppointmentReason').textContent = 'Carregando...';
            modal.querySelector('#viewAppointmentSymptoms').textContent = 'Carregando...';


            try {
                const response = await fetch(`${API_BASE}/appointments/${appointmentId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (!response.ok) throw new Error('PFSCR: Falha ao carregar detalhes da ficha.');

                const appointment = await response.json();

                modal.querySelector('#viewFichaModalTitle').innerHTML = `<i class="bi bi-file-earmark-text"></i> Ficha Médica #${String(appointment.id).padStart(4, '0')}`;
                modal.querySelector('#viewPatientName').textContent = appointment.patient?.name || 'N/A';

                const localDate = new Date(appointment.date);
                const formattedDate = localDate.toLocaleDateString('pt-BR');
                const formattedTime = localDate.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                modal.querySelector('#viewAppointmentDate').textContent = `${formattedDate} • ${formattedTime}`;

                modal.querySelector('#viewDoctorName').textContent = appointment.doctor?.name || 'N/A';
                modal.querySelector('#viewDoctorSpecialty').textContent = appointment.doctor?.specialization || 'N/A';

                const statusBadge = modal.querySelector('#viewAppointmentStatus');
                if(statusBadge) {
                    let stateText = appointment.state ? appointment.state.replace(/_/g, ' ').toLowerCase() : 'agendado';
                    stateText = stateText.charAt(0).toUpperCase() + stateText.slice(1);
                    statusBadge.textContent = stateText;
                    statusBadge.className = `status-badge status-${getStatusClass(appointment.state)}`;
                }

                modal.querySelector('#viewAppointmentType').textContent = appointment.type ? appointment.type.replace(/_/g,' ') : 'N/A';
                modal.querySelector('#viewAppointmentReason').textContent = appointment.description || 'N/A';
                modal.querySelector('#viewAppointmentSymptoms').textContent = appointment.diagnosis || 'Nenhum sintoma/diagnóstico informado';

                const confirmBtn = document.getElementById('confirmAppointmentBtn');
                const cancelBtn = document.getElementById('cancelAppointmentBtn');
                if (appointment.state === 'AGENDADO' && isAppointmentInFuture(appointment.date)) {
                    if (confirmBtn) confirmBtn.style.display = 'inline-block';
                    if (cancelBtn) cancelBtn.style.display = 'inline-block';
                } else {
                    if (confirmBtn) confirmBtn.style.display = 'none';
                    if (cancelBtn) cancelBtn.style.display = 'none';
                }
            } catch (error) {
                showError("PFSCR: Erro ao carregar detalhes da ficha no modal: " + error.message);
                // Resetar para erro
                modal.querySelector('#viewFichaModalTitle').innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Erro ao Carregar`;
            }
        }

        async function handleConfirmAppointment(appointmentId) {
            if (!confirm('Deseja confirmar sua presença para esta consulta?')) return;
            const viewFichaModalElConfirm = document.getElementById('viewFichaModal');
            try {
                const response = await fetch(`${API_BASE}/appointments/${appointmentId}/confirm`, {
                    method: 'PUT', // Ou PATCH se for o caso
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "PFSCR: Falha ao confirmar agendamento." }));
                    throw new Error(errorData.message || "PFSCR: Falha ao confirmar agendamento.");
                }

                if (viewFichaModalElConfirm) {
                    const modalInstance = bootstrap.Modal.getInstance(viewFichaModalElConfirm);
                    if (modalInstance) {
                        viewFichaModalElConfirm.addEventListener('hidden.bs.modal', async function handler() {
                            viewFichaModalElConfirm.removeEventListener('hidden.bs.modal', handler);
                            showSuccess('Agendamento confirmado com sucesso!');
                            await loadAppointments();
                            removeModalBackdropSafe();
                        }, { once: true });
                        modalInstance.hide();
                    } else { // Fallback
                        showSuccess('Agendamento confirmado com sucesso!');
                        await loadAppointments();
                        removeModalBackdropSafe();
                    }
                }
            } catch (error) {
                showError("PFSCR: Erro ao confirmar agendamento: " + error.message);
                if (viewFichaModalElConfirm && bootstrap.Modal.getInstance(viewFichaModalElConfirm)?._isShown) {
                   // Não faz nada, deixa o usuário fechar ou tentar novamente
                } else {
                    removeModalBackdropSafe();
                }
            }
        }

        async function handleCancelAppointment(appointmentId, reasonText = "Paciente cancelou") {
            if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;
            const viewFichaModalElCancel = document.getElementById('viewFichaModal');
            let isViewModalOpenAndRelevant = false;
            if (viewFichaModalElCancel) {
                const modalInstance = bootstrap.Modal.getInstance(viewFichaModalElCancel);
                if (modalInstance && modalInstance._isShown && viewFichaModalElCancel.dataset.currentAppointmentId === String(appointmentId)) {
                    isViewModalOpenAndRelevant = true;
                }
            }

            try {
                const response = await fetch(`${API_BASE}/appointments/${appointmentId}/cancel`, {
                    method: 'PATCH', // Usando PATCH para atualização parcial (estado)
                    headers: {
                        'Content-Type': 'application/json', // Mesmo sem body, alguns backends esperam
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    // body: JSON.stringify({ reason: reasonText }) // Enviar reason se o backend processar
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "PFSCR: Falha ao cancelar agendamento." }));
                    throw new Error(errorData.message || "PFSCR: Falha ao cancelar agendamento.");
                }

                if (isViewModalOpenAndRelevant) {
                    const modalInstance = bootstrap.Modal.getInstance(viewFichaModalElCancel);
                    viewFichaModalElCancel.addEventListener('hidden.bs.modal', async function handler() {
                        viewFichaModalElCancel.removeEventListener('hidden.bs.modal', handler);
                        showSuccess('Agendamento cancelado com sucesso!');
                        await loadAppointments();
                        removeModalBackdropSafe();
                    }, { once: true });
                    modalInstance.hide();
                } else {
                    showSuccess('Agendamento cancelado com sucesso!');
                    await loadAppointments();
                    removeModalBackdropSafe();
                }
            } catch (error) {
                showError("PFSCR: Erro ao cancelar agendamento: " + error.message);
                if (isViewModalOpenAndRelevant && bootstrap.Modal.getInstance(viewFichaModalElCancel)?._isShown) {
                    // Não faz nada
                } else {
                   removeModalBackdropSafe();
                }
            }
        }

        function getStatusClass(state) {
            if (!state) return 'agendado';
            const lowerState = String(state).toLowerCase().replace(/_/g, ''); // Remove underscore para a classe
            const statusMap = {
                'agendado': 'agendado',
                'concluido': 'concluido',
                'confirmado': 'confirmado',
                'cancelado': 'cancelado',
                'pendente': 'pendente',
                'em_andamento': 'em_andamento', // Adicionar se o backend tiver este estado
                'em andamento': 'em_andamento'  // Adicionar se o backend tiver este estado
            };
            return statusMap[lowerState] || 'agendado';
        }

        function isAppointmentToday(appointmentDateStr) {
           // Esta função não é mais usada para mostrar os botões, mas pode ser útil para outras lógicas.
           // A lógica foi simplificada em isAppointmentInFuture
           if (!appointmentDateStr) return false;
            const appointmentDate = new Date(appointmentDateStr);
            const today = new Date();
            return appointmentDate.getFullYear() === today.getFullYear() &&
                   appointmentDate.getMonth() === today.getMonth() &&
                   appointmentDate.getDate() === today.getDate();
        }

        function showError(message) {
            console.error("PFSCR_ERROR:", message);
            alert('Erro: ' + message);
        }

        function showSuccess(message) {
            console.log("PFSCR_SUCCESS:", message);
            const successModalEl = document.getElementById('successModal');
            const titleElement = document.getElementById('successModalLabel');
            const bodyElement = document.getElementById('successModalBody'); // Pegar o body para mensagem mais detalhada

            if (titleElement) titleElement.innerHTML = `<i class="bi bi-check-circle-fill"></i> Sucesso!`;
            if (bodyElement) bodyElement.textContent = message;

            if (successModalEl) {
                const modalInstance = bootstrap.Modal.getOrCreateInstance(successModalEl);
                modalInstance.show();
            } else {
                alert('Sucesso: ' + message); // Fallback
            }
        }
    </script>
</body>
</html>